<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <title>
        grpc-go source code trace - gRPC client 與 server 建立連線過程 - 文組工程師
      </title>
    <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  
  <meta name="theme-color" content="#000000" />
  <meta http-equiv="window-target" content="_top" />
  
  
  <meta name="description" content="前言 其實一開始的目的是想要研究 gRPC 的 retry 機制，不過在了解 retry 之前勢必要先說明整個 gRPC client 與 server 建立連線的過程，因此就先用 source code trace 的方式簡單說明在呼叫 grpc." />
  <meta name="generator" content="Hugo 0.71.0 with theme pure" />
  <title>grpc-go source code trace - gRPC client 與 server 建立連線過程 - 文組工程師</title>
  
  
  <link rel="stylesheet" href="https://yushuanhsieh.github.io/css/style.min.79b82cf2077bdd3aae7894025fd832885b1bf052912b6efa30dfdc42d7b09d22.css">
  
    
    <link rel="stylesheet" href="https://yushuanhsieh.github.io/scss/cherie.min.3669452615b597915c93c0200031dbc594c748097c6d3903e07a6f3c65024666.css" async>
  
  <link rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/9.15.10/styles/github.min.css" async>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css" async>
  <meta property="og:title" content="grpc-go source code trace - gRPC client 與 server 建立連線過程" />
<meta property="og:description" content="前言 其實一開始的目的是想要研究 gRPC 的 retry 機制，不過在了解 retry 之前勢必要先說明整個 gRPC client 與 server 建立連線的過程，因此就先用 source code trace 的方式簡單說明在呼叫 grpc." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://yushuanhsieh.github.io/post/2019-04-05-grpc-dial/" />
<meta property="article:published_time" content="2019-04-05T08:00:00+08:00" />
<meta property="article:modified_time" content="2019-04-05T08:00:00+08:00" />
<meta itemprop="name" content="grpc-go source code trace - gRPC client 與 server 建立連線過程">
<meta itemprop="description" content="前言 其實一開始的目的是想要研究 gRPC 的 retry 機制，不過在了解 retry 之前勢必要先說明整個 gRPC client 與 server 建立連線的過程，因此就先用 source code trace 的方式簡單說明在呼叫 grpc.">
<meta itemprop="datePublished" content="2019-04-05T08:00:00&#43;08:00" />
<meta itemprop="dateModified" content="2019-04-05T08:00:00&#43;08:00" />
<meta itemprop="wordCount" content="913">



<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="grpc-go source code trace - gRPC client 與 server 建立連線過程"/>
<meta name="twitter:description" content="前言 其實一開始的目的是想要研究 gRPC 的 retry 機制，不過在了解 retry 之前勢必要先說明整個 gRPC client 與 server 建立連線的過程，因此就先用 source code trace 的方式簡單說明在呼叫 grpc."/>

  <!--[if lte IE 9]>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
    <![endif]-->

  <!--[if lt IE 9]>
      <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
    <![endif]-->

</head>
  </head>

  
  

  <body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage"><header class="header" itemscope itemtype="http://schema.org/WPHeader">
    <div class="slimContent">
      <div class="navbar-header">
        <div class="profile-block text-center">
          <a id="avatar" href="" target="_blank">
            <img class="img-circle img-rotate" src="https://yushuanhsieh.github.io/author.jpg" width="200" height="200">
          </a>
          <h2 id="name" class="hidden-xs hidden-sm">Cherie Hsieh</h2>
          <h3 id="title" class="hidden-xs hidden-sm hidden-md">Software Engineer</h3>
          <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i>Taiwan</small>
        </div><div class="search" id="search-form-wrap">
    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="Search" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i
                        class="icon icon-search"></i></button>
            </span>
        </div>
        <div class="ins-search">
            <div class="ins-search-mask"></div>
            <div class="ins-search-container">
                <div class="ins-input-wrapper">
                    <input type="text" class="ins-search-input" placeholder="Type something..."
                        x-webkit-speech />
                    <button type="button" class="close ins-close ins-selectable" data-dismiss="modal"
                        aria-label="Close"><span aria-hidden="true">×</span></button>
                </div>
                <div class="ins-section-wrapper">
                    <div class="ins-section-container"></div>
                </div>
            </div>
        </div>
    </form>
</div>
        <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
      </div>
      <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
        <ul class="nav navbar-nav main-nav">
            <li class="menu-item menu-item-home">
                <a href="/">
                  <span class="menu-title">Home</span>
                </a>
            </li>
            <li class="menu-item menu-item-categories">
                <a href="/categories/">
                  <span class="menu-title">Categories</span>
                </a>
            </li>
        </ul>
      </nav>
    </div>
  </header>

<aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title"> Categories</h3>
    <div class="widget-body">
        <ul class="category-list">
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/c/" class="category-list-link">c</a><span class="category-list-count">3</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/game/" class="category-list-link">game</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/gnu/" class="category-list-link">gnu</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/go/" class="category-list-link">go</a><span class="category-list-count">12</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/google-cloud-platform/" class="category-list-link">google-cloud-platform</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/kubernetes/" class="category-list-link">kubernetes</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/life/" class="category-list-link">life</a><span class="category-list-count">2</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/meetup/" class="category-list-link">meetup</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/network/" class="category-list-link">network</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/other/" class="category-list-link">other</a><span class="category-list-count">7</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/study/" class="category-list-link">study</a><span class="category-list-count">10</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/web/" class="category-list-link">web</a><span class="category-list-count">28</span></li>
        </ul>
    </div>
</div>
      
<div class="widget">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget-body">
        <ul class="recent-post-list list-unstyled no-thumbnail">
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://yushuanhsieh.github.io/post/2020-06-25-study-05/" class="title">2020/05 月份自我學習回顧</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2020-06-25 08:00:00 &#43;0800 CST" itemprop="datePublished">2020-06-25</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://yushuanhsieh.github.io/post/2020-06-24-strings-builder/" class="title">Escape analysis issues of strings builder</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2020-06-24 08:00:00 &#43;0800 CST" itemprop="datePublished">2020-06-24</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://yushuanhsieh.github.io/post/2020-06-01-string-to-slice/" class="title">Go string to slice 議題</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2020-06-01 08:00:00 &#43;0800 CST" itemprop="datePublished">2020-06-01</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://yushuanhsieh.github.io/post/2020-05-28-ingress-gce/" class="title">Introduction to ingress-gce controller</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2020-05-28 08:00:00 &#43;0800 CST" itemprop="datePublished">2020-05-28</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://yushuanhsieh.github.io/post/2020-05-19-transfer.sh/" class="title">Side Project - Transfer.sh</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2020-05-19 08:00:00 &#43;0800 CST" itemprop="datePublished">2020-05-19</time>
                    </p>
                </div>
            </li>
        </ul>
    </div>
</div>
  </div>
</aside>

    
    
<main class="main" role="main"><div class="content">
  <article id="single-" class="article article-type-single" itemscope
    itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      <h1 itemprop="name">
  <a
    class="article-title"
    href="/post/2019-04-05-grpc-dial/"
    >
    
      
        <span class="title-cat">Web</span>
      
    grpc-go source code trace - gRPC client 與 server 建立連線過程</a>
</h1>

      <div class="article-meta">
        
<span class="article-date">
  <i class="icon icon-calendar-check"></i>&nbsp;
<a href="https://yushuanhsieh.github.io/post/2019-04-05-grpc-dial/" class="article-date">
  <time datetime="2019-04-05 08:00:00 &#43;0800 CST" itemprop="datePublished">2019-04-05</time>
</a>
</span>
<span class="article-category">
  <i class="icon icon-folder"></i>
  
    <a class="article-category-link" href="/categories/web/"> Web </a>
  
</span>

        <span class="post-comment"><i class="icon icon-comment"></i>&nbsp;<a href="/post/2019-04-05-grpc-dial/#comments"
            class="article-comment-link">Comments</a></span>
      </div>
    </div>
    <div class="article-entry marked-body js-toc-content" itemprop="articleBody">
      <h2 id="前言">前言</h2>
<p>其實一開始的目的是想要研究 gRPC 的 retry 機制，不過在了解 retry 之前勢必要先說明整個 gRPC client 與 server 建立連線的過程，因此就先用 source code trace 的方式簡單說明在呼叫 <code>grpc.Dial</code> 後所執行的連線流程，包含 gRPC 實現 load-balancing 的機制。</p>
<h2 id="packages">packages</h2>
<p>grpc-go v1.19.1</p>
<h2 id="grpcdial-的背後">grpc.Dial 的背後</h2>
<p>以下是 client 向 server 連線的基本方式。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">Dial</span>(<span style="color:#a6e22e">serverIpAddress</span>, <span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">WithInsecure</span>())

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Dial</span>(<span style="color:#a6e22e">target</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">opts</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">DialOption</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">ClientConn</span>, <span style="color:#66d9ef">error</span>) {
  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">DialContext</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#a6e22e">target</span>, <span style="color:#a6e22e">opts</span><span style="color:#f92672">...</span>)
}
</code></pre></div><p>首先， Client 需要透過 <strong>Name Resolver</strong> 解析 Dial 中的 <code>target string</code> 來取得 Server 正確的 IP Addresses 和 port，以利後續建立 connection。例如使用 DNS Name Resolver，就可以透過 <code>conn, err := grpc.Dial(&quot;dns:///your.target.name:8888&quot;)</code> 這種 Domain name 的方式來發送 RPCs。</p>
<p>關於 Name Resolution 部分可以參閱 <a href="https://github.com/grpc/grpc/blob/master/doc/naming.md">官方文件</a> 說明。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Notice: 部分 source code 被移除
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">DialContext</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">target</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">opts</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">DialOption</span>) (<span style="color:#a6e22e">conn</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ClientConn</span>, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">cc</span>.<span style="color:#a6e22e">dopts</span>.<span style="color:#a6e22e">resolverBuilder</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
	  <span style="color:#a6e22e">cc</span>.<span style="color:#a6e22e">parsedTarget</span> = <span style="color:#a6e22e">parseTarget</span>(<span style="color:#a6e22e">cc</span>.<span style="color:#a6e22e">target</span>)
	  <span style="color:#a6e22e">grpclog</span>.<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;parsed scheme: %q&#34;</span>, <span style="color:#a6e22e">cc</span>.<span style="color:#a6e22e">parsedTarget</span>.<span style="color:#a6e22e">Scheme</span>)
	  <span style="color:#a6e22e">cc</span>.<span style="color:#a6e22e">dopts</span>.<span style="color:#a6e22e">resolverBuilder</span> = <span style="color:#a6e22e">resolver</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">cc</span>.<span style="color:#a6e22e">parsedTarget</span>.<span style="color:#a6e22e">Scheme</span>)
	  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">cc</span>.<span style="color:#a6e22e">dopts</span>.<span style="color:#a6e22e">resolverBuilder</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
		  <span style="color:#75715e">// If resolver builder is still nil, the parsed target&#39;s scheme is
</span><span style="color:#75715e"></span>		  <span style="color:#75715e">// not registered. Fallback to default resolver and set Endpoint to
</span><span style="color:#75715e"></span>		  <span style="color:#75715e">// the original target.
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">grpclog</span>.<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;scheme %q not registered, fallback to default scheme&#34;</span>, <span style="color:#a6e22e">cc</span>.<span style="color:#a6e22e">parsedTarget</span>.<span style="color:#a6e22e">Scheme</span>)
			<span style="color:#a6e22e">cc</span>.<span style="color:#a6e22e">parsedTarget</span> = <span style="color:#a6e22e">resolver</span>.<span style="color:#a6e22e">Target</span>{
				<span style="color:#a6e22e">Scheme</span>:   <span style="color:#a6e22e">resolver</span>.<span style="color:#a6e22e">GetDefaultScheme</span>(),
				<span style="color:#a6e22e">Endpoint</span>: <span style="color:#a6e22e">target</span>,
			}
			<span style="color:#75715e">// Default use passthrough resolver builder (passthrough.go)
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">cc</span>.<span style="color:#a6e22e">dopts</span>.<span style="color:#a6e22e">resolverBuilder</span> = <span style="color:#a6e22e">resolver</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">cc</span>.<span style="color:#a6e22e">parsedTarget</span>.<span style="color:#a6e22e">Scheme</span>)
		}
	}
	
	<span style="color:#a6e22e">rWrapper</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">newCCResolverWrapper</span>(<span style="color:#a6e22e">cc</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;failed to build resolver: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
	}
}
</code></pre></div><p><code>Resolver</code> 是一個 interface，使用者可以根據需求來註冊不同實作的 resolver，例如 <code>etcd-io/etcd</code> 。而在沒有指定 resolver 情況下（我們可以使用 URI scheme 來選擇特定 resolver， e.g. <code>etcd://</code> ）， grpc-go 會使用預設 <code>passthrough resolver</code> 去解析名稱。(passthrough 其實就是很單純地把 target 再返回來，因此僅適用於簡單應用或是測試。另外在 gRPC 文件中有提到，預設是使用 DNS，不過 grpc-go 卻是用 passthrough)。</p>
<p>想參考第三方實作 resolver ，可參見 <a href="https://github.com/etcd-io/etcd/blob/master/clientv3/balancer/resolver/endpoint/endpoint.go">etcd clientv3 resolver</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">newCCResolverWrapper</span>(<span style="color:#a6e22e">cc</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ClientConn</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">ccResolverWrapper</span>, <span style="color:#66d9ef">error</span>) {
  <span style="color:#a6e22e">ccr</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">ccResolverWrapper</span>{
    <span style="color:#a6e22e">cc</span>:     <span style="color:#a6e22e">cc</span>,
    <span style="color:#a6e22e">addrCh</span>: make(<span style="color:#66d9ef">chan</span> []<span style="color:#a6e22e">resolver</span>.<span style="color:#a6e22e">Address</span>, <span style="color:#ae81ff">1</span>),
    <span style="color:#a6e22e">scCh</span>:   make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">string</span>, <span style="color:#ae81ff">1</span>),
  }
  <span style="color:#75715e">// Create a resolver from resolver builder
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">ccr</span>.<span style="color:#a6e22e">resolver</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">rb</span>.<span style="color:#a6e22e">Build</span>(<span style="color:#a6e22e">cc</span>.<span style="color:#a6e22e">parsedTarget</span>, <span style="color:#a6e22e">ccr</span>, <span style="color:#a6e22e">resolver</span>.<span style="color:#a6e22e">BuildOption</span>{<span style="color:#a6e22e">DisableServiceConfig</span>: <span style="color:#a6e22e">cc</span>.<span style="color:#a6e22e">dopts</span>.<span style="color:#a6e22e">disableServiceConfig</span>})
}
</code></pre></div><p>以下以 default 的 passthrough resolver 來說明接下去的流程。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Default use passthrough Builder.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#f92672">*</span><span style="color:#a6e22e">passthroughBuilder</span>) <span style="color:#a6e22e">Build</span>(<span style="color:#a6e22e">target</span> <span style="color:#a6e22e">resolver</span>.<span style="color:#a6e22e">Target</span>, <span style="color:#a6e22e">cc</span> <span style="color:#a6e22e">resolver</span>.<span style="color:#a6e22e">ClientConn</span>, <span style="color:#a6e22e">opts</span> <span style="color:#a6e22e">resolver</span>.<span style="color:#a6e22e">BuildOption</span>) (<span style="color:#a6e22e">resolver</span>.<span style="color:#a6e22e">Resolver</span>, <span style="color:#66d9ef">error</span>) {
  <span style="color:#a6e22e">r</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">passthroughResolver</span>{
		<span style="color:#a6e22e">target</span>: <span style="color:#a6e22e">target</span>,
		<span style="color:#a6e22e">cc</span>:     <span style="color:#a6e22e">cc</span>,
	}
	<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">start</span>()
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">passthroughResolver</span>) <span style="color:#a6e22e">start</span>() {
  <span style="color:#75715e">// 直接返回使用者輸入的 target
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">cc</span>.<span style="color:#a6e22e">UpdateState</span>(<span style="color:#a6e22e">resolver</span>.<span style="color:#a6e22e">State</span>{<span style="color:#a6e22e">Addresses</span>: []<span style="color:#a6e22e">resolver</span>.<span style="color:#a6e22e">Address</span>{{<span style="color:#a6e22e">Addr</span>: <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">target</span>.<span style="color:#a6e22e">Endpoint</span>}}})
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">ccr</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ccResolverWrapper</span>) <span style="color:#a6e22e">UpdateState</span>(<span style="color:#a6e22e">s</span> <span style="color:#a6e22e">resolver</span>.<span style="color:#a6e22e">State</span>) {
  <span style="color:#75715e">// 透過 wrapper 通知 ClientConn 更新 State
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">ccr</span>.<span style="color:#a6e22e">cc</span>.<span style="color:#a6e22e">updateResolverState</span>(<span style="color:#a6e22e">s</span>)
}
</code></pre></div><p>當 Name Resolver 解析完 target 之後，會透過 balancer wrapper 產生的 watcher 通知 <code>Balancer</code> 最新的 Addresses。</p>
<p>![gRPC-Dial-1.png]({{ site.url }}/assets/images/gRPC-Dial-1.png)</p>
<p><strong>Balancer</strong> 是 gRPC 實現 load-balacing 要角，它最主要負責 Handle connection 和 addresses 的狀態變化（例如當 Addresses 更新時則更新連線），以及在後續 transport 階段決定該選擇哪個 server connection(又稱為 balancer policy)。 gRPC Load Balance 採用 <a href="https://github.com/grpc/grpc/blob/master/doc/load-balancing.md#external-load-balancing-service">External Load Balancing Service</a>，讓使用者可以選擇其他實作的 Balancer。</p>
<blockquote>
<p><strong>Balancer</strong> takes input from gRPC, manages SubConns, and collects and aggregates the connectivity states. It also generates and updates the Picker used by gRPC to pick SubConns for RPCs.</p>
</blockquote>
<blockquote>
<p><strong>SubConn</strong> represents a gRPC sub connection. Each sub connection contains a list of addresses. gRPC will try to connect to them (in sequence), and stop trying the remainder once one connection is successful.</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">cc</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ClientConn</span>) <span style="color:#a6e22e">updateResolverState</span>(<span style="color:#a6e22e">s</span> <span style="color:#a6e22e">resolver</span>.<span style="color:#a6e22e">State</span>) <span style="color:#66d9ef">error</span> {
  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">cc</span>.<span style="color:#a6e22e">dopts</span>.<span style="color:#a6e22e">balancerBuilder</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">isGRPCLB</span> {
			<span style="color:#a6e22e">newBalancerName</span> = <span style="color:#a6e22e">grpclbName</span>
		} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">cc</span>.<span style="color:#a6e22e">sc</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">cc</span>.<span style="color:#a6e22e">sc</span>.<span style="color:#a6e22e">LB</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">newBalancerName</span> = <span style="color:#f92672">*</span><span style="color:#a6e22e">cc</span>.<span style="color:#a6e22e">sc</span>.<span style="color:#a6e22e">LB</span>
		} <span style="color:#66d9ef">else</span> {
		  <span style="color:#75715e">// Default use pick first balancer(pick_first.go)
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">newBalancerName</span> = <span style="color:#a6e22e">PickFirstBalancerName</span>
		}
		<span style="color:#a6e22e">cc</span>.<span style="color:#a6e22e">switchBalancer</span>(<span style="color:#a6e22e">newBalancerName</span>)
  }
  <span style="color:#a6e22e">cc</span>.<span style="color:#a6e22e">balancerWrapper</span>.<span style="color:#a6e22e">updateResolverState</span>(<span style="color:#a6e22e">s</span>)
}

<span style="color:#75715e">// Use resolverUpdateCh to pass resolved Addresses to Balancer
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">ccb</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ccBalancerWrapper</span>) <span style="color:#a6e22e">updateResolverState</span>(<span style="color:#a6e22e">s</span> <span style="color:#a6e22e">resolver</span>.<span style="color:#a6e22e">State</span>) {
  <span style="color:#a6e22e">ccb</span>.<span style="color:#a6e22e">resolverUpdateCh</span> <span style="color:#f92672">&lt;-</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">s</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">cc</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ClientConn</span>) <span style="color:#a6e22e">switchBalancer</span>(<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>) {
  <span style="color:#a6e22e">cc</span>.<span style="color:#a6e22e">balancerWrapper</span> = <span style="color:#a6e22e">newCCBalancerWrapper</span>(<span style="color:#a6e22e">cc</span>, <span style="color:#a6e22e">builder</span>, <span style="color:#a6e22e">cc</span>.<span style="color:#a6e22e">balancerBuildOpts</span>)
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">newCCBalancerWrapper</span>(<span style="color:#a6e22e">cc</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ClientConn</span>, <span style="color:#a6e22e">b</span> <span style="color:#a6e22e">balancer</span>.<span style="color:#a6e22e">Builder</span>, <span style="color:#a6e22e">bopts</span> <span style="color:#a6e22e">balancer</span>.<span style="color:#a6e22e">BuildOptions</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">ccBalancerWrapper</span> {
  <span style="color:#a6e22e">ccb</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">ccBalancerWrapper</span>{
		<span style="color:#a6e22e">cc</span>:               <span style="color:#a6e22e">cc</span>,
		<span style="color:#a6e22e">stateChangeQueue</span>: <span style="color:#a6e22e">newSCStateUpdateBuffer</span>(),
		<span style="color:#a6e22e">resolverUpdateCh</span>: make(<span style="color:#66d9ef">chan</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">resolver</span>.<span style="color:#a6e22e">State</span>, <span style="color:#ae81ff">1</span>),
		<span style="color:#a6e22e">done</span>:             make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{}),
		<span style="color:#a6e22e">subConns</span>:         make(<span style="color:#66d9ef">map</span>[<span style="color:#f92672">*</span><span style="color:#a6e22e">acBalancerWrapper</span>]<span style="color:#66d9ef">struct</span>{}),
	}
	<span style="color:#75715e">// Create a watcher for name resolved events.
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">ccb</span>.<span style="color:#a6e22e">watcher</span>() 
	<span style="color:#a6e22e">ccb</span>.<span style="color:#a6e22e">balancer</span> = <span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">Build</span>(<span style="color:#a6e22e">ccb</span>, <span style="color:#a6e22e">bopts</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ccb</span>
}
</code></pre></div><p>以下擷取 watcher 接收 resolver Update 的後續處理：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// watcher balancer functions sequentially, so the balancer can be implemented
</span><span style="color:#75715e">// lock-free.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">ccb</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ccBalancerWrapper</span>) <span style="color:#a6e22e">watcher</span>() {
  <span style="color:#66d9ef">for</span> {
		<span style="color:#66d9ef">select</span> {
		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">s</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ccb</span>.<span style="color:#a6e22e">resolverUpdateCh</span>:
			<span style="color:#66d9ef">select</span> {
			<span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ccb</span>.<span style="color:#a6e22e">done</span>:
				<span style="color:#a6e22e">ccb</span>.<span style="color:#a6e22e">balancer</span>.<span style="color:#a6e22e">Close</span>()
				<span style="color:#66d9ef">return</span>
			<span style="color:#66d9ef">default</span>:
			}
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ub</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ccb</span>.<span style="color:#a6e22e">balancer</span>.(<span style="color:#a6e22e">balancer</span>.<span style="color:#a6e22e">V2Balancer</span>); <span style="color:#a6e22e">ok</span> {
				<span style="color:#a6e22e">ub</span>.<span style="color:#a6e22e">UpdateResolverState</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">s</span>)
			} <span style="color:#66d9ef">else</span> {
				<span style="color:#a6e22e">ccb</span>.<span style="color:#a6e22e">balancer</span>.<span style="color:#a6e22e">HandleResolvedAddrs</span>(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Addresses</span>, <span style="color:#66d9ef">nil</span>)
			}
		}
	}
}
</code></pre></div><p>這邊以簡單地 pick first balancer 為例，觀察 Balancer Handle resolved addresses 實際行為。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">pickfirstBalancer</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">cc</span> <span style="color:#a6e22e">balancer</span>.<span style="color:#a6e22e">ClientConn</span>
	<span style="color:#a6e22e">sc</span> <span style="color:#a6e22e">balancer</span>.<span style="color:#a6e22e">SubConn</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">b</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">pickfirstBalancer</span>) <span style="color:#a6e22e">HandleResolvedAddrs</span>(<span style="color:#a6e22e">addrs</span> []<span style="color:#a6e22e">resolver</span>.<span style="color:#a6e22e">Address</span>, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">grpclog</span>.<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;pickfirstBalancer: HandleResolvedAddrs called with error %v&#34;</span>, <span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">sc</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">sc</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">cc</span>.<span style="color:#a6e22e">NewSubConn</span>(<span style="color:#a6e22e">addrs</span>, <span style="color:#a6e22e">balancer</span>.<span style="color:#a6e22e">NewSubConnOptions</span>{})
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">grpclog</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;pickfirstBalancer: failed to NewSubConn: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">return</span>
		}
		<span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">cc</span>.<span style="color:#a6e22e">UpdateBalancerState</span>(<span style="color:#a6e22e">connectivity</span>.<span style="color:#a6e22e">Idle</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">picker</span>{<span style="color:#a6e22e">sc</span>: <span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">sc</span>})
		<span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">sc</span>.<span style="color:#a6e22e">Connect</span>() <span style="color:#75715e">// Connect to server (b.sc is balancer_conn_wrapper)
</span><span style="color:#75715e"></span>	} <span style="color:#66d9ef">else</span> {
		<span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">sc</span>.<span style="color:#a6e22e">UpdateAddresses</span>(<span style="color:#a6e22e">addrs</span>)
		<span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">sc</span>.<span style="color:#a6e22e">Connect</span>()
	}
}
</code></pre></div><p>上面可以看到如果沒有 subConn ，則會透過 <code>balancer_conn_wrapper</code> 通知 ClientConn 新建一條 SubConn，接著觸發 Connnect。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">ac</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">addrConn</span>) <span style="color:#a6e22e">connect</span>() <span style="color:#66d9ef">error</span> {
  <span style="color:#a6e22e">ac</span>.<span style="color:#a6e22e">updateConnectivityState</span>(<span style="color:#a6e22e">connectivity</span>.<span style="color:#a6e22e">Connecting</span>)
	<span style="color:#a6e22e">ac</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Unlock</span>()

	<span style="color:#75715e">// Start a goroutine connecting to the server asynchronously.
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">ac</span>.<span style="color:#a6e22e">resetTransport</span>()
}
</code></pre></div><p>此時就會另起 goroutine 來正式與 Server 建立連線。
![gRPC-Dial-2.png]({{ site.url }}/assets/images/gRPC-Dial-2.png)</p>
<p><code>resetTransport</code> 是一個無限循環的迴圈，意味著如果 Server 端異常導致 disconnect 時，client 端會重新嘗試連線，直到連線成功或是 <code>connectivity.Shutdown</code> 為止。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">ac</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">addrConn</span>) <span style="color:#a6e22e">resetTransport</span>() {
  <span style="color:#75715e">// Reconnect forever
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; ; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">i</span> &gt; <span style="color:#ae81ff">0</span> {
			<span style="color:#a6e22e">ac</span>.<span style="color:#a6e22e">cc</span>.<span style="color:#a6e22e">resolveNow</span>(<span style="color:#a6e22e">resolver</span>.<span style="color:#a6e22e">ResolveNowOption</span>{})
		}

		<span style="color:#a6e22e">ac</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Lock</span>()
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ac</span>.<span style="color:#a6e22e">state</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">connectivity</span>.<span style="color:#a6e22e">Shutdown</span> {
			<span style="color:#a6e22e">ac</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Unlock</span>()
			<span style="color:#66d9ef">return</span>
		}

		<span style="color:#a6e22e">newTr</span>, <span style="color:#a6e22e">addr</span>, <span style="color:#a6e22e">reconnect</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ac</span>.<span style="color:#a6e22e">tryAllAddrs</span>(<span style="color:#a6e22e">addrs</span>, <span style="color:#a6e22e">connectDeadline</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">ac</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Lock</span>()
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ac</span>.<span style="color:#a6e22e">state</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">connectivity</span>.<span style="color:#a6e22e">Shutdown</span> {
				<span style="color:#a6e22e">ac</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Unlock</span>()
				<span style="color:#66d9ef">return</span>
			}
			<span style="color:#a6e22e">ac</span>.<span style="color:#a6e22e">updateConnectivityState</span>(<span style="color:#a6e22e">connectivity</span>.<span style="color:#a6e22e">TransientFailure</span>)

			<span style="color:#75715e">// Backoff.
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">b</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ac</span>.<span style="color:#a6e22e">resetBackoff</span>
			<span style="color:#a6e22e">ac</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Unlock</span>()

      <span style="color:#75715e">// wait and reconnect
</span><span style="color:#75715e"></span>		  <span style="color:#a6e22e">timer</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">NewTimer</span>(<span style="color:#a6e22e">backoffFor</span>)
			<span style="color:#66d9ef">select</span> {
			<span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">timer</span>.<span style="color:#a6e22e">C</span>:
				<span style="color:#a6e22e">ac</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Lock</span>()
				<span style="color:#a6e22e">ac</span>.<span style="color:#a6e22e">backoffIdx</span><span style="color:#f92672">++</span>
				<span style="color:#a6e22e">ac</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Unlock</span>()
			<span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">b</span>:
				<span style="color:#a6e22e">timer</span>.<span style="color:#a6e22e">Stop</span>()
			<span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ac</span>.<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Done</span>():
				<span style="color:#a6e22e">timer</span>.<span style="color:#a6e22e">Stop</span>()
				<span style="color:#66d9ef">return</span>
			}
			<span style="color:#66d9ef">continue</span>
		}

		<span style="color:#a6e22e">ac</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Lock</span>()
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ac</span>.<span style="color:#a6e22e">state</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">connectivity</span>.<span style="color:#a6e22e">Shutdown</span> {
			<span style="color:#a6e22e">newTr</span>.<span style="color:#a6e22e">Close</span>()
			<span style="color:#a6e22e">ac</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Unlock</span>()
			<span style="color:#66d9ef">return</span>
		}
		<span style="color:#a6e22e">ac</span>.<span style="color:#a6e22e">curAddr</span> = <span style="color:#a6e22e">addr</span>
		<span style="color:#a6e22e">ac</span>.<span style="color:#a6e22e">transport</span> = <span style="color:#a6e22e">newTr</span>
		<span style="color:#a6e22e">ac</span>.<span style="color:#a6e22e">backoffIdx</span> = <span style="color:#ae81ff">0</span>

    <span style="color:#75715e">// A connection with Ready state can be picked
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">healthcheckManagingState</span> {
			<span style="color:#a6e22e">ac</span>.<span style="color:#a6e22e">updateConnectivityState</span>(<span style="color:#a6e22e">connectivity</span>.<span style="color:#a6e22e">Ready</span>)
		}
		<span style="color:#a6e22e">ac</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Unlock</span>()
		
		<span style="color:#75715e">// Block until the created transport is down. And when this happens,
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// we restart from the top of the addr list.
</span><span style="color:#75715e"></span>		<span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">reconnect</span>.<span style="color:#a6e22e">Done</span>()
		<span style="color:#a6e22e">hcancel</span>()
}
</code></pre></div><p>如果在一開始的 <code>grpc.Dial</code> 額外設置 <code>grpc.WithBlock</code>，則會等到確認 <code>connectivity.Ready</code> 後才會返回。不然在預設狀態下是 non-blocking ，讓 Client 在等待連線成功之餘可以做更多事情。</p>
<p>最後可以透過實驗來觀察 gRPC log，對流程有更深刻的了解。只要加入 environment variable
<code>GRPC_GO_LOG_VERBOSITY_LEVEL=99 GRPC_GO_LOG_SEVERITY_LEVEL=info</code></p>
<p>就會看到在無法與 server 連線的情況下， client 會不斷地進行反覆重新連線行為。</p>
<p>![gRPC-Dial-3.png]({{ site.url }}/assets/images/gRPC-Dial-3.png)</p>
<h2 id="references">References</h2>
<ol>
<li><a href="https://github.com/grpc/grpc/blob/master/doc/load-balancing.md">https://github.com/grpc/grpc/blob/master/doc/load-balancing.md</a></li>
</ol>

    </div>
    <div class="article-footer">
<blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    <li class="post-copyright-link hidden-xs">
      <strong>Permalink: </strong>
      <a href="https://yushuanhsieh.github.io/post/2019-04-05-grpc-dial/" title="grpc-go source code trace - gRPC client 與 server 建立連線過程" target="_blank" rel="external">https://yushuanhsieh.github.io/post/2019-04-05-grpc-dial/</a>
    </li>
  </ul>
</blockquote>

<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="https://yushuanhsieh.github.io/author.jpg" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="" target="_blank"><span class="text-dark">Cherie Hsieh</span><small class="ml-1x">Software Engineer</small></a></h3>
        <div>Gopher</div>
      </div>
    </figure>
  </div>
</div>
    </div>
  </article>

</div><nav class="bar bar-footer clearfix" data-stick-bottom>
    <div class="bar-inner">
        <ul class="pager pull-left">
            <li class="prev">
                <a href="https://yushuanhsieh.github.io/post/2019-04-04-study-201903/" title="2019/03月份自我學習回顧"><i
                        class="icon icon-angle-left"
                        aria-hidden="true"></i><span>&nbsp;&nbsp;Older</span></a>
            </li>
            <li class="next">
                <a href="https://yushuanhsieh.github.io/post/2019-05-04-study-201904/"
                    title="2019/04月份自我學習回顧"><span>Newer&nbsp;&nbsp;</span><i
                        class="icon icon-angle-right" aria-hidden="true"></i></a>
            </li>
            
        </ul>
        <div class="bar-right">
        </div>
    </div>
</nav>

</main><footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
  <div class="copyright">
    &copy;2017  -
    2020
    <div class="publishby">
        Theme by <a href="https://github.com/xiaoheiAh" target="_blank"> xiaoheiAh </a>base on<a href="https://github.com/xiaoheiAh/hugo-theme-pure" target="_blank"> pure</a>.
    </div>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>
<script>
    window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>
<script type="text/javascript" src="https://cdn.staticfile.org/highlight.js/9.15.10/highlight.min.js"></script>
<script type="text/javascript" src="https://cdn.staticfile.org/highlight.js/9.15.10/languages/go.min.js" defer></script>
<script type="text/javascript" src="https://cdn.staticfile.org/highlight.js/9.15.10/languages/javascript.min.js" defer></script>
<script type="text/javascript" src="https://cdn.staticfile.org/highlight.js/9.15.10/languages/c.min.js" defer></script><script>
    hljs.configure({
        tabReplace: '    ', 
        classPrefix: ''     
        
    })
    hljs.initHighlightingOnLoad();
</script>
<script src="https://yushuanhsieh.github.io/js/application.min.bdeb64b910570b6c41badc6a05b7afb0c8ad9efd8525de3c7257d59e786326a3.js"></script>
<script src="https://yushuanhsieh.github.io/js/plugin.min.51ff8c7317566f82259170fa36e09c4493adc9b9378b427a01ad3f017ebac7dd.js"></script>

<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: 'Posts',
                PAGES: 'Pages',
                CATEGORIES: 'Categories',
                TAGS: 'Tags',
                UNTITLED: '(Untitled)',
            },
            ROOT_URL: 'https:\/\/yushuanhsieh.github.io',
            CONTENT_URL: 'https:\/\/yushuanhsieh.github.io\/searchindex.json ',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script type="text/javascript" src="https://yushuanhsieh.github.io/js/insight.min.a343cd9a5a7698336b28ef3a7c16a3a1b1d2d5fb17dc8ed04022bbe08cc5459073a15bdafa3a8a58cdd56080784bdd69fa70b1ae8597565c799c57ed00f0e120.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
<script>
    tocbot.init({
        
        tocSelector: '.js-toc',
        
        contentSelector: '.js-toc-content',
        
        headingSelector: 'h1, h2, h3',
        
        hasInnerContainers: true,
    });
</script>


  </body>
</html>
