<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <title>
        Start HTTP/2 running over cleartext TCP - 文組工程師
      </title>
    <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  
  <meta name="theme-color" content="#000000" />
  <meta http-equiv="window-target" content="_top" />
  
  
  <meta name="description" content="![flow]({{ site.url }}/assets/images/h2c-flow.png)
前言 主流使用 HTTP/2 時都是基於 TLS protocol，不過在 HTTP/2 RFC7540 規範中， HTTP/2 其實也可以直接基於 cleartext TCP 來溝通。這次主要介紹 based on cleartext TCP 的 HTTP/2 server 與 client 實作，後續會再加入 HTTP/2 結合 TLS protocol 的相關內容。" />
  <meta name="generator" content="Hugo 0.67.0 with theme pure" />
  <title>Start HTTP/2 running over cleartext TCP - 文組工程師</title>
  
  
  <link rel="stylesheet" href="https://yushuanhsieh.github.io/css/style.min.79b82cf2077bdd3aae7894025fd832885b1bf052912b6efa30dfdc42d7b09d22.css">
  
    
    <link rel="stylesheet" href="https://yushuanhsieh.github.io/scss/cherie.min.25e69b63f709fdfaf070b38e72e556d2a25931840ee2fcdc62b4aa0b9803e9ba.css" async>
  
  <link rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/9.15.10/styles/github.min.css" async>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css" async>
  <meta property="og:title" content="Start HTTP/2 running over cleartext TCP" />
<meta property="og:description" content="![flow]({{ site.url }}/assets/images/h2c-flow.png)
前言 主流使用 HTTP/2 時都是基於 TLS protocol，不過在 HTTP/2 RFC7540 規範中， HTTP/2 其實也可以直接基於 cleartext TCP 來溝通。這次主要介紹 based on cleartext TCP 的 HTTP/2 server 與 client 實作，後續會再加入 HTTP/2 結合 TLS protocol 的相關內容。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://yushuanhsieh.github.io/post/2019-08-27-http2-h2c/" />
<meta property="article:published_time" content="2019-08-27T08:00:00+08:00" />
<meta property="article:modified_time" content="2019-08-27T08:00:00+08:00" />
<meta itemprop="name" content="Start HTTP/2 running over cleartext TCP">
<meta itemprop="description" content="![flow]({{ site.url }}/assets/images/h2c-flow.png)
前言 主流使用 HTTP/2 時都是基於 TLS protocol，不過在 HTTP/2 RFC7540 規範中， HTTP/2 其實也可以直接基於 cleartext TCP 來溝通。這次主要介紹 based on cleartext TCP 的 HTTP/2 server 與 client 實作，後續會再加入 HTTP/2 結合 TLS protocol 的相關內容。">
<meta itemprop="datePublished" content="2019-08-27T08:00:00&#43;08:00" />
<meta itemprop="dateModified" content="2019-08-27T08:00:00&#43;08:00" />
<meta itemprop="wordCount" content="1234">



<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Start HTTP/2 running over cleartext TCP"/>
<meta name="twitter:description" content="![flow]({{ site.url }}/assets/images/h2c-flow.png)
前言 主流使用 HTTP/2 時都是基於 TLS protocol，不過在 HTTP/2 RFC7540 規範中， HTTP/2 其實也可以直接基於 cleartext TCP 來溝通。這次主要介紹 based on cleartext TCP 的 HTTP/2 server 與 client 實作，後續會再加入 HTTP/2 結合 TLS protocol 的相關內容。"/>

  <!--[if lte IE 9]>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
    <![endif]-->

  <!--[if lt IE 9]>
      <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
    <![endif]-->

</head>
  </head>

  
  

  <body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage"><header class="header" itemscope itemtype="http://schema.org/WPHeader">
    <div class="slimContent">
      <div class="navbar-header">
        <div class="profile-block text-center">
          <a id="avatar" href="" target="_blank">
            <img class="img-circle img-rotate" src="https://yushuanhsieh.github.io/author.jpg" width="200" height="200">
          </a>
          <h2 id="name" class="hidden-xs hidden-sm">Cherie Hsieh</h2>
          <h3 id="title" class="hidden-xs hidden-sm hidden-md">Software Engineer</h3>
          <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i>Taiwan</small>
        </div><div class="search" id="search-form-wrap">
    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="Search" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i
                        class="icon icon-search"></i></button>
            </span>
        </div>
        <div class="ins-search">
            <div class="ins-search-mask"></div>
            <div class="ins-search-container">
                <div class="ins-input-wrapper">
                    <input type="text" class="ins-search-input" placeholder="Type something..."
                        x-webkit-speech />
                    <button type="button" class="close ins-close ins-selectable" data-dismiss="modal"
                        aria-label="Close"><span aria-hidden="true">×</span></button>
                </div>
                <div class="ins-section-wrapper">
                    <div class="ins-section-container"></div>
                </div>
            </div>
        </div>
    </form>
</div>
        <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
      </div>
      <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
        <ul class="nav navbar-nav main-nav">
            <li class="menu-item menu-item-home">
                <a href="/">
                  <span class="menu-title">Home</span>
                </a>
            </li>
            <li class="menu-item menu-item-categories">
                <a href="/categories/">
                  <span class="menu-title">Categories</span>
                </a>
            </li>
        </ul>
      </nav>
    </div>
  </header>

<aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title"> Categories</h3>
    <div class="widget-body">
        <ul class="category-list">
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/c/" class="category-list-link">c</a><span class="category-list-count">3</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/game/" class="category-list-link">game</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/gnu/" class="category-list-link">gnu</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/go/" class="category-list-link">go</a><span class="category-list-count">8</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/life/" class="category-list-link">life</a><span class="category-list-count">2</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/meetup/" class="category-list-link">meetup</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/network/" class="category-list-link">network</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/other/" class="category-list-link">other</a><span class="category-list-count">7</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/study/" class="category-list-link">study</a><span class="category-list-count">9</span></li>
            <li class="category-list-item"><a href="https://yushuanhsieh.github.io/categories/web/" class="category-list-link">web</a><span class="category-list-count">28</span></li>
        </ul>
    </div>
</div>
      
<div class="widget">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget-body">
        <ul class="recent-post-list list-unstyled no-thumbnail">
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://yushuanhsieh.github.io/post/2020-04-22-discourse-deployment/" class="title">Discourse Forums Deployment</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2020-04-22 08:00:00 &#43;0800 CST" itemprop="datePublished">2020-04-22</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://yushuanhsieh.github.io/post/2020-04-15-transfer-sh-refactor/" class="title">Trace transfer.sh open project</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2020-04-15 08:00:00 &#43;0800 CST" itemprop="datePublished">2020-04-15</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://yushuanhsieh.github.io/post/2020-04-07-hugo-merge/" class="title">Multilingual Mode in Hugo</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2020-04-07 08:00:00 &#43;0800 CST" itemprop="datePublished">2020-04-07</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://yushuanhsieh.github.io/post/2020-03-31-march/" class="title">三月起，在竹北定區生活</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2020-03-31 08:00:00 &#43;0800 CST" itemprop="datePublished">2020-03-31</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://yushuanhsieh.github.io/post/2020-02-24-february/" class="title">2月雜談</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2020-02-24 08:00:00 &#43;0800 CST" itemprop="datePublished">2020-02-24</time>
                    </p>
                </div>
            </li>
        </ul>
    </div>
</div>
  </div>
</aside>

    
    
<main class="main" role="main"><div class="content">
  <article id="single-" class="article article-type-single" itemscope
    itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      <h1 itemprop="name">
  <a
    class="article-title"
    href="/post/2019-08-27-http2-h2c/"
    >
    
      
        
          <span class="title-cat">Network</span>
        
          <span class="title-cat">Go</span>
        
      
    Start HTTP/2 running over cleartext TCP</a>
</h1>

      <div class="article-meta">
        
<span class="article-date">
  <i class="icon icon-calendar-check"></i>&nbsp;
<a href="https://yushuanhsieh.github.io/post/2019-08-27-http2-h2c/" class="article-date">
  <time datetime="2019-08-27 08:00:00 &#43;0800 CST" itemprop="datePublished">2019-08-27</time>
</a>
</span>
<span class="article-category">
  <i class="icon icon-folder"></i>
  
    <a class="article-category-link" href="/categories/network/"> Network </a>
    <a class="article-category-link" href="/categories/go/"> Go </a>
</span>

        <span class="post-comment"><i class="icon icon-comment"></i>&nbsp;<a href="/post/2019-08-27-http2-h2c/#comments"
            class="article-comment-link">Comments</a></span>
      </div>
    </div>
    <div class="article-entry marked-body js-toc-content" itemprop="articleBody">
      <p>![flow]({{ site.url }}/assets/images/h2c-flow.png)</p>
<h2 id="前言">前言</h2>
<p>主流使用 HTTP/2 時都是基於 TLS protocol，不過在 HTTP/2 RFC7540 規範中， HTTP/2 其實也可以直接基於 cleartext TCP 來溝通。這次主要介紹 based on cleartext TCP 的 HTTP/2 server 與 client 實作，後續會再加入 HTTP/2 結合 TLS protocol 的相關內容。</p>
<h2 id="http2-version-identification">HTTP/2 Version Identification</h2>
<p>在 <a href="https://httpwg.org/specs/rfc7540.html#versioning">RFC7540 3.1</a> 中有明確定義出 HTTP/2 on TLS protocol or cleartext TCP 的識別號，這個識別主要用於 client 端詢問 server 對於 HTTP/2 的 protocol 支援，以及切換到 HTTP/2 的過程。</p>
<h3 id="1-h2">1. h2</h3>
<p>The string &ldquo;h2&rdquo; identifies the protocol where HTTP/2 uses Transport Layer Security (TLS).</p>
<h3 id="2-h2c">2. h2c</h3>
<p>The string &ldquo;h2c&rdquo; identifies the protocol where HTTP/2 is run over cleartext TCP.</p>
<p>為了方便辨識，以下會直接以 <code>h2</code> <code>h2c</code> 代號來表示基於不同 protocol 的 HTTP/2。</p>
<p>而在h2c 部分，有更細節的說明：</p>
<blockquote>
<p>This identifier is used in the <strong>HTTP/1.1 Upgrade header field</strong> and in any place where HTTP/2 over TCP is identified.</p>
<p>The &ldquo;h2c&rdquo; string is <strong>reserved from the ALPN identifier</strong> space but describes a protocol that does not use TLS.</p>
</blockquote>
<p>Client 與 server 在決定要用什麼 protocol 溝通時，h2 基於 TLS ，因此是採用 <code>TLS-ALPN(Application-Layer Protocol Negotiation)</code> 方式；至於 h2c 沒有 TLS ，所以就走 HTTP/1.1 Upgrade 機制，在 request header 中會加入 <code>Upgrade:h2c</code>，讓 server 可以根據此來辨識是否支援並且 upgrade。</p>
<h4 id="upgrading-from-http2">Upgrading from HTTP/2</h4>
<p>(<a href="https://httpwg.org/specs/rfc7540.html#versioning">RFC7540 8.1.1</a>)雖然 HTTP/1.1 可以透過 <code>Upgrade</code> 機制來切換到 HTTP/2 protocol，但是 HTTP/2 卻是明確禁止這樣的行為，也因此無法透過這樣的 upgrade 機制從 HTTP/2 轉換到其他 protocol。</p>
<h2 id="h2c-http2-server">h2c HTTP/2 Server</h2>
<p>在上面內容有提到，h2c HTTP/2 server 要能識別 HTTP/1.1 Upgrade 機制，並且給予適當回應，因此這也是在實作 server 時的首要功能。</p>
<h3 id="httpserver-with-h2c-handler"><code>http.Server</code> with <code>h2c handler</code></h3>
<p>用 Go 建立 h2c server 的方式很簡單，一樣是使用大家熟悉的 <code>net/http</code> package <code>Server.ListenAndServe</code> 來啟動 server 並接收後續的 request，不過因為必須處理 HTTP/2 型態的 request，所以可以猜到我們需要調整 <code>Handler</code> 設定，來讓 server 能了解 HTTP/2 格式的 request。</p>
<p>調整 Handler 的方式，可以透過 <code>&quot;golang.org/x/net/http2/h2c&quot;</code> package 來達成目的。使用 <code>h2c.NewHandler</code> method 就能產生 <code>h2cHandler</code>， h2cHandler 會根據 request 的內容來判斷後續執行方式：</p>
<ol>
<li>
<p><strong>HTTP/2</strong>: 如果讀到 client HTTP/2 Connection Preface(<a href="https://httpwg.org/specs/rfc7540.html#ConnectionHeader">RFC7540-3.5</a>，後面會說明)，就會建立額外的 http2.serverConn，後續 request 將由這新的 connect 來接收處理。</p>
</li>
<li>
<p><strong>HTTP/1.1 upgrade to HTTP/2 h2c</strong>: 第二種情況則是 request 包含 protocol upgrade 資訊(<a href="https://httpwg.org/specs/rfc7540.html#discover-http">RFC7540-3.2</a>)，如果可以 upgrade，就會將 HTTP 內容轉換成 HTTP/2 格式，接著同樣地新建 http2.serverConn 來處理 request。</p>
</li>
<li>
<p><strong>HTTP</strong>: 如果沒有包含任何 HTTP/2 和 Upgrade 資訊，就當成一般 HTTP request 處理。</p>
</li>
</ol>
<p>有了這些概念後，我們就可以知道 h2c server 該如何建立。</p>
<h3 id="h2c-server-example">H2c Server Example</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
    <span style="color:#e6db74">&#34;fmt&#34;</span>
    <span style="color:#e6db74">&#34;log&#34;</span>
    <span style="color:#e6db74">&#34;net/http&#34;</span>

    <span style="color:#e6db74">&#34;golang.org/x/net/http2&#34;</span>
    <span style="color:#e6db74">&#34;golang.org/x/net/http2/h2c&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">h2serv</span> <span style="color:#a6e22e">http2</span>.<span style="color:#a6e22e">Server</span>

    <span style="color:#a6e22e">handler</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">HandlerFunc</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Fprint</span>(<span style="color:#a6e22e">w</span>, <span style="color:#e6db74">&#34;HTTP/2 Server Example&#34;</span>)
    })

    <span style="color:#a6e22e">serv</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Server</span>{
        <span style="color:#a6e22e">Addr</span>:    <span style="color:#e6db74">&#34;:9090&#34;</span>,
        <span style="color:#75715e">// Create a h2c handler to dispatch incoming requests.
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">Handler</span>: <span style="color:#a6e22e">h2c</span>.<span style="color:#a6e22e">NewHandler</span>(<span style="color:#a6e22e">handler</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">h2serv</span>),
    }

    <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Start server %s&#34;</span>, <span style="color:#a6e22e">serv</span>.<span style="color:#a6e22e">Addr</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">serv</span>.<span style="color:#a6e22e">ListenAndServe</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ErrServerClosed</span> {
        <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Panicln</span>(<span style="color:#a6e22e">err</span>)
    }
}
</code></pre></div><p>在網路上可能會看到以下寫法：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">server</span> <span style="color:#a6e22e">http2</span>.<span style="color:#a6e22e">Server</span>

    <span style="color:#a6e22e">l</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Listen</span>(<span style="color:#e6db74">&#34;tcp&#34;</span>, <span style="color:#e6db74">&#34;localhost:9090&#34;</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalln</span>(<span style="color:#a6e22e">err</span>)
    }

    <span style="color:#66d9ef">for</span> {
        <span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">Accept</span>()
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalln</span>(<span style="color:#a6e22e">err</span>)
        }

        <span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">ServeConn</span>(<span style="color:#a6e22e">conn</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">http2</span>.<span style="color:#a6e22e">ServeConnOpts</span>{
            <span style="color:#a6e22e">Handler</span>: <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">HandlerFunc</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
                <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Fprintf</span>(<span style="color:#a6e22e">w</span>, <span style="color:#e6db74">&#34;HTTP/2 Server Example&#34;</span>)
            }),
        })
    }
}
</code></pre></div><p>這種 low-level API <code>l.Accept()</code> Loop，並且直接使用 <code>server.ServeConn</code> 的做法等於省略了 <code>h2cHandler</code>  這層判斷，讓 request 直接進入 HTTP/2 格式處理。建議還是使用 <code>h2c.NewHandler</code> 作法，讓 server handler 比較有彈性。</p>
<h2 id="h2c-client">H2c Client</h2>
<p>有了 HTTP/2 server 後，就寫個簡單的 client 來進行測試吧！</p>
<p>首先，Client 端發出含有 <code>Upgrade:h2c</code> 的 HTTP request 到 server 端，然後確認 response 是否如預期。</p>
<h3 id="1-建立-upgrade-request">1. 建立 upgrade request</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">NewRequest</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">MethodGet</span>, <span style="color:#e6db74">&#34;http://localhost:9090&#34;</span>, <span style="color:#66d9ef">nil</span>)
<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Header</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#e6db74">&#34;Upgrade&#34;</span>, <span style="color:#e6db74">&#34;h2c&#34;</span>)
</code></pre></div><h3 id="2-加入更多-http2-upgrade-requirement">2. 加入更多 HTTP/2 upgrade requirement</h3>
<p>光有 <code>Upgrade:h2c</code> 還不夠，還要有 <code>HTTP2-Settings</code> Header Field 以及其內容。</p>
<blockquote>
<p>The content of the HTTP2-Settings header field is the payload of a SETTINGS frame, encoded as a base64url string.</p>
</blockquote>
<p>HTTP2-Settings 其實就是 HTTP/2 的 SETTINGS frame(<a href="https://httpwg.org/specs/rfc7540.html#SETTINGS">RFC7540 6.5</a>)，其值用來進行溝通期間的參數設定，例如更新 window size 或是 設定 max frame size 等。只不過因為我們起初是發送 HTTP request，所以就將值 encoding 後放入到 <code>HTTP2-Settings</code> header field 中。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">settings</span> <span style="color:#f92672">:=</span> []<span style="color:#66d9ef">byte</span>{<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0xa</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0xfa</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">6</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">01</span>, <span style="color:#ae81ff">0x40</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>}
<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">NewRequest</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">MethodGet</span>, <span style="color:#e6db74">&#34;http://localhost:9000&#34;</span>, <span style="color:#66d9ef">nil</span>)
<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Header</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#e6db74">&#34;Connection&#34;</span>, <span style="color:#e6db74">&#34;HTTP2-Settings&#34;</span>)
<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Header</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#e6db74">&#34;HTTP2-Settings&#34;</span>, <span style="color:#a6e22e">base64</span>.<span style="color:#a6e22e">RawURLEncoding</span>.<span style="color:#a6e22e">EncodeToString</span>(<span style="color:#a6e22e">settings</span>))
</code></pre></div><p>簡單說明一下，settings 的內容是由數個 Identifier (16 bit) +  Value (32 bit) 所組成，其格式定義在 <a href="https://httpwg.org/specs/rfc7540.html#SettingFormat">RFC7540 6.5.1 SETTINGS FORMAT</a>。</p>
<p>舉例來說：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">[]<span style="color:#66d9ef">byte</span>{<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0xa</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>}
<span style="color:#75715e">// big-endian
</span><span style="color:#75715e">// 0x5 - SETTINGS_MAX_FRAME_SIZE, value - 0xa0000 = 655360
</span></code></pre></div><p>最後，為什麼 upgrade request 需要 <code>HTTP2-Settings</code>，在 <a href="https://httpwg.org/specs/rfc7540.html#Http2SettingsHeader">RFC7540 3.2.1</a> 有解答：</p>
<blockquote>
<p>Providing these values (HTTP2-Settings) in the upgrade request gives a client an opportunity to provide parameters prior to receiving any frames from the server.</p>
</blockquote>
<h3 id="3-send-upgrade-request-and-get-response">3. Send upgrade request and get response</h3>
<p>Client sample code</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Dial</span>(<span style="color:#e6db74">&#34;tcp&#34;</span>, <span style="color:#e6db74">&#34;localhost:9000&#34;</span>)
<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
  <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalln</span>(<span style="color:#a6e22e">err</span>)
}

<span style="color:#a6e22e">req</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">newUpgradeRequest</span>()

<span style="color:#75715e">// send a request
</span><span style="color:#75715e"></span><span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">conn</span>)

<span style="color:#75715e">// get data from server
</span><span style="color:#75715e"></span><span style="color:#a6e22e">buf</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">bufio</span>.<span style="color:#a6e22e">NewReader</span>(<span style="color:#a6e22e">conn</span>)

<span style="color:#75715e">// convert data to HTTP response format. 
</span><span style="color:#75715e"></span><span style="color:#a6e22e">resp</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ReadResponse</span>(<span style="color:#a6e22e">buf</span>, <span style="color:#a6e22e">req</span>)
<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalln</span>(<span style="color:#a6e22e">err</span>)
}

<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">resp</span>.<span style="color:#a6e22e">StatusCode</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusSwitchingProtocols</span> {
	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalln</span>(<span style="color:#e6db74">&#34;server does not support h2c&#34;</span>)
}
</code></pre></div><p>為了 re-use <code>net.Conn</code> 以及使用 http2.Client，因此就採用 low level API 的方式來發送 HTTP request。</p>
<p>我們從 Wireshark 可以看到結果，在正確設置了 upgrade header 後，就會回應 switching protocols response，而這也正是我們所預期的。</p>
<p>![flow]({{ site.url }}/assets/images/h2c-upgrade-1.png)</p>
<p>而從 Go server Debug tool 來看 (其實就是在 go run server.go 前面加上<code>GODEBUG=http2debug=2</code>)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#ae81ff">2019</span><span style="color:#f92672">/</span><span style="color:#ae81ff">08</span><span style="color:#f92672">/</span><span style="color:#ae81ff">27</span> <span style="color:#ae81ff">15</span><span style="color:#f92672">:</span><span style="color:#ae81ff">23</span><span style="color:#f92672">:</span><span style="color:#ae81ff">33</span> http2: Framer <span style="color:#ae81ff">0xc0001420e0</span><span style="color:#f92672">:</span> wrote SETTINGS len<span style="color:#f92672">=</span><span style="color:#ae81ff">24</span>, settings: MAX_FRAME_SIZE<span style="color:#f92672">=</span><span style="color:#ae81ff">655360</span>, MAX_CONCURRENT_STREAMS<span style="color:#f92672">=</span><span style="color:#ae81ff">250</span>, MAX_HEADER_LIST_SIZE<span style="color:#f92672">=</span><span style="color:#ae81ff">655680</span>, INITIAL_WINDOW_SIZE<span style="color:#f92672">=</span><span style="color:#ae81ff">655360</span>
</code></pre></div><p>MAX_FRAME_SIZE value 也有正確被 server 讀取，皆大歡喜！</p>
<p>反之，如果只設置 <code>Upgrade:&quot;h2c&quot;</code> 而沒有設置 <code>HTTP2-Settings</code> 的情況下：</p>
<p>![flow]({{ site.url }}/assets/images/h2c-upgrade-2.png)</p>
<p>Server 只會把這個 request 當作 HTTP 來處理，就直接回 200 以及對應的 response data 啦～</p>
<h3 id="4-starting-http2-with-prior-knowledge">4. Starting HTTP/2 with Prior Knowledge</h3>
<p>根據規範指示，當我們收到 101 response，就需要接著發送 connection preface (<a href="https://httpwg.org/specs/rfc7540.html#known-http">RFC7540 3.4</a>) 以利 server 繼續進行 HTTP/2 connection 建立。</p>
<blockquote>
<p>Upon receiving the 101 response, the client MUST send a <strong>connection preface</strong> (Section 3.5), which includes a SETTINGS frame.</p>
</blockquote>
<p>從 h2c.go source code 也可以看到有這樣的確認機制：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// h2cUpgrade establishes a h2c connection using the HTTP/1 upgrade (Section 3.2).
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">h2cUpgrade</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) (<span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Conn</span>, <span style="color:#66d9ef">error</span>) {
	
	<span style="color:#75715e">// more...
</span><span style="color:#75715e"></span>	
	<span style="color:#a6e22e">rw</span>.<span style="color:#a6e22e">Write</span>([]byte(<span style="color:#e6db74">&#34;HTTP/1.1 101 Switching Protocols\r\n&#34;</span> <span style="color:#f92672">+</span>
		<span style="color:#e6db74">&#34;Connection: Upgrade\r\n&#34;</span> <span style="color:#f92672">+</span>
		<span style="color:#e6db74">&#34;Upgrade: h2c\r\n\r\n&#34;</span>))
	<span style="color:#a6e22e">rw</span>.<span style="color:#a6e22e">Flush</span>()

	<span style="color:#75715e">// A conforming client will now send an H2 client preface which need to drain
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// since we already sent this.
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">drainClientPreface</span>(<span style="color:#a6e22e">rw</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}

	<span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">rwConn</span>{
		<span style="color:#a6e22e">Conn</span>:      <span style="color:#a6e22e">conn</span>,
		<span style="color:#a6e22e">Reader</span>:    <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">MultiReader</span>(<span style="color:#a6e22e">initBytes</span>, <span style="color:#a6e22e">rw</span>),
		<span style="color:#a6e22e">BufWriter</span>: <span style="color:#a6e22e">newSettingsAckSwallowWriter</span>(<span style="color:#a6e22e">rw</span>.<span style="color:#a6e22e">Writer</span>),
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>, <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>如果 client 沒有接著發送 <code>connection preface</code> 那該連線就無法成立。</p>
<p>因此，我們就繼續實作 client，在收到 101 status code 後，就接著使用 <code>http2.Transport.NewClientConn</code> 來建立 client conn 並發送 client connection preface。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">tr</span> <span style="color:#a6e22e">http2</span>.<span style="color:#a6e22e">Transport</span>
<span style="color:#a6e22e">http2Conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">tr</span>.<span style="color:#a6e22e">NewClientConn</span>(<span style="color:#a6e22e">conn</span>)
<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalln</span>(<span style="color:#a6e22e">err</span>)
}
</code></pre></div><h4 id="http2transportnewclientconn">http2.Transport.NewClientConn</h4>
<p>client connection preface 在 NewClientConn 階段就會發送給 server 端，從 source code 可以看到相關實作。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Transport</span>) <span style="color:#a6e22e">newClientConn</span>(<span style="color:#a6e22e">c</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Conn</span>, <span style="color:#a6e22e">singleUse</span> <span style="color:#66d9ef">bool</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">ClientConn</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">cc</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">ClientConn</span>{
		<span style="color:#a6e22e">t</span>:                     <span style="color:#a6e22e">t</span>,
		<span style="color:#a6e22e">tconn</span>:                 <span style="color:#a6e22e">c</span>,
		<span style="color:#a6e22e">readerDone</span>:            make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{}),
		<span style="color:#a6e22e">nextStreamID</span>:          <span style="color:#ae81ff">1</span>,
		<span style="color:#a6e22e">maxFrameSize</span>:          <span style="color:#ae81ff">16</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">10</span>,           <span style="color:#75715e">// spec default
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">initialWindowSize</span>:     <span style="color:#ae81ff">65535</span>,              <span style="color:#75715e">// spec default
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">maxConcurrentStreams</span>:  <span style="color:#ae81ff">1000</span>,               <span style="color:#75715e">// &#34;infinite&#34;, per spec. 1000 seems good enough.
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">peerMaxHeaderListSize</span>: <span style="color:#ae81ff">0xffffffffffffffff</span>, <span style="color:#75715e">// &#34;infinite&#34;, per spec. Use 2^64-1 instead.
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">streams</span>:               make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">uint32</span>]<span style="color:#f92672">*</span><span style="color:#a6e22e">clientStream</span>),
		<span style="color:#a6e22e">singleUse</span>:             <span style="color:#a6e22e">singleUse</span>,
		<span style="color:#a6e22e">wantSettingsAck</span>:       <span style="color:#66d9ef">true</span>,
		<span style="color:#a6e22e">pings</span>:                 make(<span style="color:#66d9ef">map</span>[[<span style="color:#ae81ff">8</span>]<span style="color:#66d9ef">byte</span>]<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{}),
	}
	
	<span style="color:#75715e">// skip..
</span><span style="color:#75715e"></span>
	<span style="color:#75715e">// send the client connection preface
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">cc</span>.<span style="color:#a6e22e">bw</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">clientPreface</span>)
	
	<span style="color:#a6e22e">cc</span>.<span style="color:#a6e22e">fr</span>.<span style="color:#a6e22e">WriteSettings</span>(<span style="color:#a6e22e">initialSettings</span><span style="color:#f92672">...</span>)
	<span style="color:#a6e22e">cc</span>.<span style="color:#a6e22e">fr</span>.<span style="color:#a6e22e">WriteWindowUpdate</span>(<span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">transportDefaultConnFlow</span>)
	<span style="color:#a6e22e">cc</span>.<span style="color:#a6e22e">inflow</span>.<span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">transportDefaultConnFlow</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">initialWindowSize</span>)
	<span style="color:#a6e22e">cc</span>.<span style="color:#a6e22e">bw</span>.<span style="color:#a6e22e">Flush</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">cc</span>.<span style="color:#a6e22e">werr</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">cc</span>.<span style="color:#a6e22e">werr</span>
	}

	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">cc</span>.<span style="color:#a6e22e">readLoop</span>()
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">cc</span>, <span style="color:#66d9ef">nil</span>
}
</code></pre></div><h3 id="5-communicating-communications">5. Communicating communications</h3>
<p>最後，連線建立完成，可以開始開啟新 stream 並且交換 frames！</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">NewRequest</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">MethodGet</span>, <span style="color:#e6db74">&#34;http://localhost:9000&#34;</span>, <span style="color:#66d9ef">nil</span>)
<span style="color:#a6e22e">http2Conn</span>.<span style="color:#a6e22e">RoundTrip</span>(<span style="color:#a6e22e">req</span>)
</code></pre></div><p>![flow]({{ site.url }}/assets/images/h2c-upgrade-3.png)</p>
<h2 id="831-補充關於-http2transport">8/31 補充：關於 http2.Transport</h2>
<p>在整合 demo code 成為一個完整的 h2c-client 時，發現一個連線 bug。</p>
<p>當 client 發送一個包含 HTTP/2 upgrade 的 HTTP request 時， server 在接收到後，會將其格式轉成 HTTP/2 ，並在後續建立起 HTTP/2 連線時，會把這個資訊放入 buffer 中。HTTP/2 連線建立成功， server 發送完初始 SETTINGS frames 後，就會緊接著將這個 request 處理完並且將 response 回應給 client 端。</p>
<p>此時，這個 response 的 stream ID 為 <code>0x1</code> (<a href="https://httpwg.org/specs/rfc7540.html#StreamIdentifiers">RFC 7540 5.1.1</a>)，但是 client 端在接收到 response 後卻會顯示 error， error 內容為收到未預期的 stream ID ，並強制關閉 connection。</p>
<p>查看了一下 client transport source code，發現 transport 在接收 DATA frame 時會檢查 stream ID 是否超出 request 的 stream ID。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">rl</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">clientConnReadLoop</span>) <span style="color:#a6e22e">processData</span>(<span style="color:#a6e22e">f</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">DataFrame</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#a6e22e">neverSent</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cc</span>.<span style="color:#a6e22e">nextStreamID</span>
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">StreamID</span> <span style="color:#f92672">&gt;=</span> <span style="color:#a6e22e">neverSent</span> {
		<span style="color:#75715e">// We never asked for this.
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">cc</span>.<span style="color:#a6e22e">logf</span>(<span style="color:#e6db74">&#34;http2: Transport received unsolicited DATA frame; closing connection&#34;</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ConnectionError</span>(<span style="color:#a6e22e">ErrCodeProtocol</span>)
	}
}
</code></pre></div><p>看的出來是 <code>nextStreamID</code> 的問題。這時候回去看 <code>newClientConn</code> source code，會看到 <code>nextStreamID</code> 會被初始化成 <code>1</code>，而此時因為 client 端在 HTTP/2 連線建立成功後，還沒有發送任何 request，因此 <code>nextStreamID</code> 維持 1，進而造成這樣的錯誤回報。</p>
<p>那麼要如何避免這樣的錯誤發生呢？</p>
<p>一個蠻 tricky 的做法，就是:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">tr</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">http2</span>.<span style="color:#a6e22e">Transport</span>{<span style="color:#a6e22e">AllowHTTP</span>: <span style="color:#66d9ef">true</span>}
</code></pre></div><p>把 Transport 的 AllowHTTP 設定為 true。雖然根據官方 source code 的說法：</p>
<blockquote>
<p>AllowHTTP, if true, permits HTTP/2 requests using the insecure, plain-text &ldquo;http&rdquo; scheme. Note that this does not enable h2c support.</p>
</blockquote>
<p>看起來好像跟問題沒有什麼太大關係，不過這樣的設定會更動到 <code>nextStreamID</code> 的值。一樣是在 <code>newClientConn</code> method：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">AllowHTTP</span> {
	<span style="color:#a6e22e">cc</span>.<span style="color:#a6e22e">nextStreamID</span> = <span style="color:#ae81ff">3</span>
}
</code></pre></div><p>因為 nextStreamID 初始值變成 3 了，所以當接收到 response 的 stream ID 為 1 時，判斷就會是正常結果，避免掉上述的問題。</p>
<p>老實說，把 nextStreamID 設置為 3，對我來說是一個蠻 magic number 的行為，code 裡面也沒有解釋為什麼是 3 而不是 4,5,6,7 &hellip; ，不過既然可以解決了，就這樣吧 XD 畢竟 Go 本來的 HTTP2 package 本來就是預設 TLS 行為，這個錯誤只會發生在使用 HTTP/1.1 upgrade 後而已。</p>
<h2 id="sample-codes">Sample Codes</h2>
<h3 id="server">Server</h3>
<p>{%gist YuShuanHsieh/c902a1bd245b9ad52e30f832d2cc9ab3 %}</p>
<h3 id="client">Client</h3>
<p>{%gist YuShuanHsieh/e249dfe245df7612d7fdd9cb7333ba16 %}</p>

    </div>
    <div class="article-footer">
<blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    <li class="post-copyright-link hidden-xs">
      <strong>Permalink: </strong>
      <a href="https://yushuanhsieh.github.io/post/2019-08-27-http2-h2c/" title="Start HTTP/2 running over cleartext TCP" target="_blank" rel="external">https://yushuanhsieh.github.io/post/2019-08-27-http2-h2c/</a>
    </li>
  </ul>
</blockquote>

<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="https://yushuanhsieh.github.io/author.jpg" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="" target="_blank"><span class="text-dark">Cherie Hsieh</span><small class="ml-1x">Software Engineer</small></a></h3>
        <div>Gopher</div>
      </div>
    </figure>
  </div>
</div>
    </div>
  </article>

</div><nav class="bar bar-footer clearfix" data-stick-bottom>
    <div class="bar-inner">
        <ul class="pager pull-left">
            <li class="prev">
                <a href="https://yushuanhsieh.github.io/post/2019-08-18-sem-glibc/" title="semaphore sem_post 在 glibc v2.0 v2.1 之比較"><i
                        class="icon icon-angle-left"
                        aria-hidden="true"></i><span>&nbsp;&nbsp;Older</span></a>
            </li>
            <li class="next">
                <a href="https://yushuanhsieh.github.io/post/2019-09-07-201908-study/"
                    title="2019/08月份自我學習回顧"><span>Newer&nbsp;&nbsp;</span><i
                        class="icon icon-angle-right" aria-hidden="true"></i></a>
            </li>
            
        </ul>
        <div class="bar-right">
        </div>
    </div>
</nav>

</main><footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
  <div class="copyright">
    &copy;2017  -
    2020
    <div class="publishby">
        Theme by <a href="https://github.com/xiaoheiAh" target="_blank"> xiaoheiAh </a>base on<a href="https://github.com/xiaoheiAh/hugo-theme-pure" target="_blank"> pure</a>.
    </div>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>
<script>
    window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>
<script type="text/javascript" src="https://cdn.staticfile.org/highlight.js/9.15.10/highlight.min.js"></script>
<script type="text/javascript" src="https://cdn.staticfile.org/highlight.js/9.15.10/languages/go.min.js" defer></script>
<script type="text/javascript" src="https://cdn.staticfile.org/highlight.js/9.15.10/languages/javascript.min.js" defer></script>
<script type="text/javascript" src="https://cdn.staticfile.org/highlight.js/9.15.10/languages/c.min.js" defer></script><script>
    hljs.configure({
        tabReplace: '    ', 
        classPrefix: ''     
        
    })
    hljs.initHighlightingOnLoad();
</script>
<script src="https://yushuanhsieh.github.io/js/application.min.bdeb64b910570b6c41badc6a05b7afb0c8ad9efd8525de3c7257d59e786326a3.js"></script>
<script src="https://yushuanhsieh.github.io/js/plugin.min.51ff8c7317566f82259170fa36e09c4493adc9b9378b427a01ad3f017ebac7dd.js"></script>

<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: 'Posts',
                PAGES: 'Pages',
                CATEGORIES: 'Categories',
                TAGS: 'Tags',
                UNTITLED: '(Untitled)',
            },
            ROOT_URL: 'https:\/\/yushuanhsieh.github.io',
            CONTENT_URL: 'https:\/\/yushuanhsieh.github.io\/searchindex.json ',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script type="text/javascript" src="https://yushuanhsieh.github.io/js/insight.min.a343cd9a5a7698336b28ef3a7c16a3a1b1d2d5fb17dc8ed04022bbe08cc5459073a15bdafa3a8a58cdd56080784bdd69fa70b1ae8597565c799c57ed00f0e120.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
<script>
    tocbot.init({
        
        tocSelector: '.js-toc',
        
        contentSelector: '.js-toc-content',
        
        headingSelector: 'h1, h2, h3',
        
        hasInnerContainers: true,
    });
</script>


  </body>
</html>
